# حل مشكلة: ERROR: 42703: column "category_id" does not exist

هذا الخطأ يحدث عندما يحاول النظام الوصول إلى جداول نظام الصلاحيات المتقدم التي لم يتم إنشاؤها بعد في قاعدة البيانات.

## الحل السريع

### الخطوة 1: تطبيق SQL Script يدوياً

1. اذهب إلى لوحة تحكم Supabase: [https://supabase.com/dashboard](https://supabase.com/dashboard)
2. اختر مشروعك
3. من القائمة الجانبية، اختر **SQL Editor**
4. انشئ استعلام جديد (New Query)
5. انسخ والصق محتوى الملف `manual-permissions-setup.sql` الموجود في جذر المشروع
6. اضغط **Run** لتنفيذ الاستعلام

### الخطوة 2: التحقق من نجاح العملية

بعد تشغيل الاستعلام، يجب أن ترى رسالة نجاح:
```
تم إنشاء نظام الصلاحيات المتقدم بنجاح! يمكنك الآن استخدام جميع ميزات النظام.
```

### الخطوة 3: تحديث الصفحة

1. ارجع إلى تطبيقك
2. حدث الصفحة (F5 أو Ctrl+R)
3. يجب أن يعمل نظام الصلاحيات الآن بشكل طبيعي

## ما يتم إنشاؤه

الاستعلام سينشئ:

### الجداول الأساسية:
- `permission_categories` - فئات الصلاحيات
- `permissions` - الصلاحيات المفصلة
- `roles` - الأدوار
- `role_permissions` - ربط الأدوار بالصلاحيات
- `permission_audit_log` - سجل تتبع الأنشطة

### البيانات الأساسية:
- 6 فئات صلاحيات (النظام، المستخدمين، الأسطول، الأعمال، المالية، الأساسيات)
- 16 صلاحية مفصلة
- 7 أدوار (من مدير النظام إلى المستخدم العادي)
- توزيع الصلاحيات على الأدوار

### الدوال المساعدة:
- `user_has_permission()` - للتحقق من صلاحية مستخدم
- `get_user_permissions()` - للحصول على قائمة صلاحيات المستخدم

### أمان البيانات:
- Row Level Security (RLS) على جميع الجداول
- Policies أساسية للحماية

## إذا استمرت المشكلة

### التحقق من الجداول:
```sql
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('permission_categories', 'permissions', 'roles', 'role_permissions');
```

### التحقق من البيانات:
```sql
SELECT 
  (SELECT COUNT(*) FROM permission_categories) as categories,
  (SELECT COUNT(*) FROM permissions) as permissions,
  (SELECT COUNT(*) FROM roles) as roles;
```

### إعادة تشغيل النظام:
إذا كان لديك خادم محلي للتطوير، أعد تشغيله بعد تطبيق الاستعلام.

## نصائح إضافية

1. **لا تكرر تشغيل الاستعلام** - الاستعلام محمي ضد التكرار ولن يضر بالبيانات الموجودة

2. **تحديث الصلاحيات** - إذا كنت تريد تعديل الصلاحيات لاحقاً، استخدم واجهة النظام في صفحة Super Admin > Permissions Management

3. **المستخدمين الحاليين** - الاستعلام سيحدث أدوار المستخدمين الحاليين تلقائياً بناءً على أدوارهم القديمة

4. **النسخ الاحتياطي** - يُنصح بأخذ نسخة احتياطية من قاعدة البيانات قبل تطبيق تحديثات كبيرة

## الدعم

إذا واجهت أي مشاكل إضافية، تأكد من:
- صحة اتصالك بقاعدة البيانات
- أن لديك صلاحيات إدارية في Supabase
- أن جميع الجداول الأساسية للنظام موجودة (tenants، tenant_users، إلخ)

بعد تطبيق هذا الحل، ستتمكن من استخدام جميع ميزات نظام الصلاحيات المتقدم بما في ذلك:
- إدارة الأدوار والصلاحيات
- تخصيص الصلاحيات للمستخدمين
- حماية المكونات والصفحات بناءً على الصلاحيات
- تتبع أنشطة الصلاحيات 