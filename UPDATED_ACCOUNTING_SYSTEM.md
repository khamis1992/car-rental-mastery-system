# النظام المحاسبي الموحد - تحديث 2025

## 🎯 ملخص التحديث

تم تحديث النظام المحاسبي في نظام إدارة تأجير السيارات ليستخدم نظام ترقيم موحد ومنسق. هذا التحديث يضمن:

- **توحيد أرقام الحسابات** في جميع أجزاء النظام
- **إزالة التضارب** بين الدليل المحاسبي والكود
- **تحسين الأداء** وسهولة الصيانة
- **دعم المعايير المحاسبية الحديثة**

## 📋 دليل الحسابات الجديد

### 1. الأصول (Assets) - 1XXXXX

#### الأصول الجارية (11XXXX)
- **110101** - النقدية في الصندوق
- **110102** - نقدية فرع المطار
- **110103** - بنك الكويت الوطني
- **110104** - بنك الخليج
- **110105** - بنك برقان

#### العملاء (110XXX)
- **110201** - عملاء - أفراد
- **110202** - عملاء - شركات
- **110203** - عملاء - جهات حكومية
- **110204** - عملاء - مؤسسات
- **110205** - عملاء - أجانب

#### المخزون (113XXX)
- **110301** - قطع الغيار
- **110302** - الوقود
- **110303** - الزيوت والسوائل
- **110304** - أدوات ومعدات

#### الأصول الثابتة (12XXXX)
- **120301** - سيارات الأجرة
- **120302** - حافلات النقل
- **120303** - المعدات والآلات
- **120304** - مجمع إهلاك المركبات

### 2. الخصوم (Liabilities) - 2XXXXX

#### الخصوم الجارية (21XXXX)
- **210101** - موردون
- **210102** - أوراق الدفع
- **210201** - مستحقات الرواتب
- **210203** - مستحقات ضريبية
- **210301** - ودائع العملاء
- **210302** - تأمينات العملاء

#### الخصوم طويلة الأجل (22XXXX)
- **2201** - قروض طويلة الأجل
- **2202** - مخصص نهاية الخدمة

### 3. حقوق الملكية (Equity) - 3XXXX

- **3101** - رأس المال المدفوع
- **3201** - الاحتياطي القانوني
- **3301** - أرباح مرحلة من سنوات سابقة
- **3401** - أرباح السنة الجارية

### 4. الإيرادات (Revenue) - 4XXXXX

#### إيرادات التأجير (41XXXX)
- **410101** - إيراد تأجير سيارات يومي
- **410102** - إيراد تأجير سيارات أسبوعي
- **410103** - إيراد تأجير سيارات شهري
- **410104** - إيراد تأجير سيارات سنوي

#### إيرادات النقل (410XXX)
- **410201** - إيراد تأجير حافلات يومي
- **410202** - إيراد تأجير حافلات أسبوعي

#### إيرادات الخدمات (42XXXX)
- **4201** - إيرادات التوصيل والاستلام
- **4202** - إيرادات الصيانة الخارجية
- **4203** - إيرادات خدمات إضافية

### 5. المصروفات (Expenses) - 5XXXXX

#### الرواتب والأجور (51XXXX)
- **510101** - رواتب الإدارة
- **510102** - رواتب الموظفين
- **510103** - مكافآت وعلاوات

#### التشغيل والصيانة (510XXX)
- **510201** - الوقود
- **510202** - الصيانة والإصلاح
- **510203** - قطع الغيار
- **510204** - تأمين المركبات

#### الإدارة والتسويق (521XXX)
- **521101** - الإيجارات
- **521102** - الكهرباء والماء
- **521103** - الاتصالات
- **521104** - الدعاية والإعلان

#### الإهلاك (510XXX)
- **510402** - إهلاك المركبات
- **510403** - إهلاك المعدات

## 🔧 القيود المحاسبية الجديدة

### 1. قيود العقود
```sql
-- عند إنشاء العقد
من حـ/ عملاء - أفراد (110201)           XXX
    إلى حـ/ إيراد تأجير سيارات يومي (410101)   XXX

-- عند استلام الدفعة
من حـ/ النقدية في الصندوق (110101)        XXX
    إلى حـ/ عملاء - أفراد (110201)          XXX
```

### 2. قيود الرواتب
```sql
-- راتب شهري
من حـ/ رواتب الموظفين (510102)          XXX
من حـ/ مكافآت وعلاوات (510103)          XXX
    إلى حـ/ مستحقات الرواتب (210201)        XXX
    إلى حـ/ مستحقات ضريبية (210203)        XXX
```

### 3. قيود الصيانة
```sql
-- صيانة المركبات
من حـ/ الصيانة والإصلاح (510202)         XXX
من حـ/ قطع الغيار (510203)              XXX
    إلى حـ/ موردون (210101)               XXX
    إلى حـ/ النقدية في الصندوق (110101)    XXX
```

### 4. قيود الإهلاك
```sql
-- إهلاك شهري للمركبات
من حـ/ إهلاك المركبات (510402)          XXX
    إلى حـ/ مجمع إهلاك المركبات (120304)   XXX
```

## 🚀 كيفية التحديث

### 1. تشغيل سكريبت التحديث
```bash
# تشغيل سكريبت التحديث على قاعدة البيانات
psql -d your_database -f update_accounting_system.sql
```

### 2. التحقق من النتائج
```sql
-- التحقق من نجاح التحديث
SELECT verify_unified_accounting_system();
```

### 3. فحص الحسابات المطلوبة
```sql
-- فحص وجود الحسابات الأساسية
SELECT account_code, account_name, is_active 
FROM chart_of_accounts 
WHERE account_code IN ('110101', '110201', '410101', '510102')
ORDER BY account_code;
```

## 📊 الملفات المحدثة

### 1. الوثائق
- ✅ `docs/accounting-guide.md` - دليل النظام المحاسبي المحدث
- ✅ `src/lib/documentsPDFService.ts` - خدمة PDF للوثائق
- ✅ `src/lib/htmlDocumentsService.ts` - خدمة HTML للوثائق

### 2. خدمات المحاسبة
- ✅ `src/services/contractAccountingService.ts` - خدمة محاسبة العقود
- ✅ `src/services/payrollAccountingService.ts` - خدمة محاسبة الرواتب

### 3. قاعدة البيانات
- ✅ `supabase/migrations/20250114110000-update-chart-of-accounts-to-unified-system.sql` - migration التحديث
- ✅ `update_accounting_system.sql` - سكريبت التحديث المستقل

## 🛠️ الدوال الجديدة

### 1. دالة التحديث
```sql
SELECT update_to_unified_accounting_system();
```
تحديث جميع الحسابات في النظام للأرقام الجديدة.

### 2. دالة التحقق
```sql
SELECT verify_unified_accounting_system();
```
التحقق من اكتمال التحديث وصحة الحسابات.

### 3. دالة التحقق بالمؤسسة
```sql
SELECT verify_unified_chart_of_accounts('tenant_id');
```
التحقق من حسابات مؤسسة معينة.

## 🔍 التحقق من النجاح

### مؤشرات النجاح:
- [ ] جميع الحسابات القديمة تم تحديثها
- [ ] لا توجد مراجع مكسورة في الكود
- [ ] جميع الحسابات الأساسية موجودة
- [ ] القيود المحاسبية تعمل بشكل صحيح

### فحص سريع:
```sql
-- عدد الحسابات لكل مؤسسة
SELECT 
    t.name as tenant_name,
    COUNT(coa.id) as total_accounts
FROM tenants t
LEFT JOIN chart_of_accounts coa ON t.id = coa.tenant_id
WHERE t.status = 'active'
GROUP BY t.id, t.name
ORDER BY t.name;
```

## 📞 الدعم الفني

في حالة وجود أي مشاكل:
1. تحقق من log الأخطاء في قاعدة البيانات
2. تأكد من وجود backup للبيانات
3. تشغيل دالة التحقق للتأكد من اكتمال التحديث

---

**تاريخ التحديث**: 14 يناير 2025  
**إصدار النظام**: 2.0.0  
**حالة التحديث**: مكتمل ✅ 